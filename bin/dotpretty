#!/usr/bin/env ruby

require "dotpretty/color_palettes/bash"
require "dotpretty/color_palettes/null"
require "dotpretty/reporters/names"
require "dotpretty/runner"
require "dotpretty/version"
require "optparse"

options = {}
OptionParser.new do |opts|

  opts.banner = "Usage: dotnet test -v=normal Test.Project/ | dotnet [options]"

  opts.on("-c", "--color", "Enable color output") do |color|
    options[:color] = color
  end

  opts.on("-h", "--help", "Display this help") do
    puts opts
    exit
  end

  all_reporter_names = Dotpretty::Reporters::Names::ALL
  reporter_message = ["Set reporter. Defaults to basic", "Available reporters: #{all_reporter_names.join(", ")}"]
  opts.on("-rREPORTER", "--reporter=REPORTER", *reporter_message) do |reporter_name|
    options[:reporter_name] = reporter_name
  end

  if STDIN.tty?
    puts "Version: #{Dotpretty::VERSION}"
    $stderr.puts opts.help
    exit 1
  end

end.parse!

color_palette = options[:color] ? Dotpretty::ColorPalettes::Bash : Dotpretty::ColorPalettes::Null
runner = Dotpretty::Runner.new({
  color_palette: color_palette,
  output: STDOUT,
  reporter_name: options[:reporter_name]
})
STDIN.each_line { |line| runner.parse_line(line) }
runner.done_with_input
